{% extends "layout.html" %} {% block title %} Log In {% endblock %} {% block
main %}
<h1 class="mt-4">Log In</h1>
<p class="lead">Please enter your credentials to log in.</p>
<form
  action="/login"
  method="post"
  class="text-start"
  style="max-width: 400px; margin: 0 auto"
>
  <div class="mb-3">
    <label for="identifier" class="form-label">Username, Email, or Phone</label>
    <input id="identifier" name="identifier" class="form-control" required />
  </div>
  <div class="mb-3">
    <label for="password" class="form-label">Password</label>
    <input
      id="password"
      name="password"
      type="password"
      class="form-control"
      required
    />
  </div>
  <button class="btn btn-primary" type="submit">Log In</button>
</form>
<!--
<div class="text-center mt-3">
  <a href="{{ url_for('google.login') }}" class="btn btn-danger">
    <i class="bi bi-google"></i> Sign in with Google
  </a>
</div>
-->
<p class="mt-3">
  Don't have an account? <a href="/register">Register here</a>.
</p>
<p>
  <a href="/forgot">Forgot your password?</a>
  {% endblock %}
</p>
<button type="button" class="btn btn-secondary mt-2" id="login-passkey">
  Login with Passkey
</button>
<script>
  document.getElementById("login-passkey").onclick = async function () {
    const identifier = document.getElementById("identifier").value;
    const resp = await fetch("/passkey/login/begin", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ identifier }),
    });
    if (!resp.ok) return alert("No passkey registered for this user.");
    const options = await resp.arrayBuffer();
    const cred = await navigator.credentials.get({
      publicKey: CBOR.decode(options),
    });
    const complete = await fetch("/passkey/login/complete", {
      method: "POST",
      body: CBOR.encode({
        credentialId: cred.rawId,
        clientDataJSON: cred.response.clientDataJSON,
        authenticatorData: cred.response.authenticatorData,
        signature: cred.response.signature,
      }),
    });
    if (complete.ok) window.location = "/";
    else alert("Passkey login failed.");
  };
</script>
