{% extends "layout.html" %} {% block title %}World Clock{% endblock %} {% block
main %}
<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
<div class="container py-4">
  <div class="row justify-content-center">
    <div class="col-md-10">
      <div class="card shadow">
        <div class="card-body">
          <h3 class="card-title mb-3">
            <i class="bi bi-globe"></i> World Clock
          </h3>
          <div id="map" style="height: 400px; border-radius: 1rem"></div>
          <div id="clockInfo" class="mt-3 text-center"></div>
        </div>
      </div>
    </div>
  </div>
</div>
<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
<script>
  let map = L.map("map").setView([20, 0], 2);
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    maxZoom: 6,
  }).addTo(map);

  function showTime(lat, lng) {
    fetch(`https://worldtimeapi.org/api/timezone/Etc/GMT`)
      .then(() =>
        fetch(
          `https://api.bigdatacloud.net/data/timezone-by-location?latitude=${lat}&longitude=${lng}&key={{ bigdatacloud_api_key }}`
        )
      )
      .then((r) => r.json())
      .then((data) => {
        let tz = data.timezone || "Etc/GMT";
        fetch(`https://worldtimeapi.org/api/timezone/${tz}`)
          .then((r2) => r2.json())
          .then((tzdata) => {
            let dt = new Date(tzdata.datetime);
            document.getElementById("clockInfo").innerHTML = `<h5>${
              data.timezone || "Unknown"
            }</h5><div style="font-size:2em;">${dt.toLocaleTimeString()}</div>`;
          });
      })
      .catch(() => {
        document.getElementById(
          "clockInfo"
        ).innerHTML = `<div class="text-danger">Could not fetch time for this location.</div>`;
      });
  }

  map.on("click", function (e) {
    showTime(e.latlng.lat, e.latlng.lng);
    L.marker([e.latlng.lat, e.latlng.lng]).addTo(map);
  });

  // Optionally, highlight user's current location/time
  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(function (pos) {
      let lat = pos.coords.latitude,
        lng = pos.coords.longitude;
      L.circleMarker([lat, lng], {
        radius: 10,
        color: "#0d6efd",
        fillColor: "#0d6efd",
        fillOpacity: 0.5,
      }).addTo(map);
      showTime(lat, lng);
    });
  }
</script>
{% endblock %}
